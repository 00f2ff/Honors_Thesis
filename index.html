<!DOCTYPE html>
<html>
<head>
	<title>Shopping</title>
	<link rel="stylesheet" type="text/css" href="research.css">
</head>
<body>

	<!-- Overlay handles 6x4 key rhombus -->
	<div id="overlay">
		<!-- 1-6 -->
		<div class="hover-row"></div>
		<!-- Q-Y -->
		<div class="hover-row"></div>
		<!-- A-H -->
		<div class="hover-row"></div>
		<!-- Z-N -->
		<div class="hover-row"></div>
	</div>
	<div id="search">
		<div id="title">Shopping</div>
		<div id="search-bar">
			<form>
				<input type="text" />
			</form>
			<div id="search-icon"></div>
		</div>
	</div>
	<div id="content-wrapper">
		<!-- link list -->
		<div id="link_list">
			<ul></ul>
		</div>
		<!-- table -->
		<div id="table">
		<!-- Will be different for Home / Suggestion vs Product -->
			<!-- I found that sites like Amazon and Etsy never show more than 3 products per row, so I'm going to reverse rows and columns; Q, A and Z will access indexes 0, 1 and 2, respectively, and hovering over keys to the right will show products farther down the page -->			
		</div>
	</div>


<!-- such javascript -->
<script src="scripts/jquery-1.11.3.min.js"></script>
<script src="scripts/global.js"></script>
<script src="scripts/table.js"></script>
<script src="scripts/product_table.js"></script>
<script src="scripts/link_list.js"></script>
<script src="scripts/api_key.js"></script>
<script src="scripts/etsy.js"></script>
<script>


	var etsy = new Etsy();
	etsy.getRequest('listings', 'listings/trending', {'limit': 30});
	etsy.getRequest('categories', 'taxonomy/categories', {});
	// etsy.getRequest('listings', 'listings/active', {'limit': 30, 'category': 'candles'});
	// etsy.getRequest('listings', 'listings/active', {'limit': 30, 'keywords': 'birthday%20cards'}); // search will just replace spaces %20 and remove all other non-alphabetical characters
	// etsy.getRequest('sub-categories', 'taxonomy/categories/accessories', {});

	// Keycode arrays. Index of key corresponds with index of cell in hover-row
	var linkListKeyCodes = [49,50,51,52,53,54];
	var tableFirstColumnKeyCodes = [81,87,69,82,84,89];
	var tableSecondColumnKeyCodes = [65,83,68,70,71,72];
	var tableThirdColumnKeyCodes = [90,88,67,86,66,78];

	// Note: I don't think I need to preventDefault on keypresses since I'm not using special keys

	
	// Assigns click handler to cells (effect differs based on cell type)
	// $('body').on('click', '.cell', function(e) {
	$('body').keydown(function(e) {
		// find which hover-row had a cell pressed
		var kc = e.keyCode;
		// find out whether UI is showing Table or ProductTable (because no arrow control / activation on latter)
		// AND is located on select conditionals (does not apply to LinkList)
		var isTable = $('.hover-row:nth-child(3)').children().length;
		console.log(isTable);
		console.log(kc);		
		if (linkListKeyCodes.indexOf(kc) > -1) {
			activateCategoryCell(kc);
		} else if (tableFirstColumnKeyCodes.indexOf(kc) > -1 && isTable) {
			activateTableCell(kc, 2);
		} else if (tableSecondColumnKeyCodes.indexOf(kc) > -1 && isTable) {
			activateTableCell(kc, 3);
		} else if (tableThirdColumnKeyCodes.indexOf(kc) > -1 && isTable) {
			activateTableCell(kc, 4);
		} else if (kc === 37) { // left arrow
			// Find which row is currently hovered over
			// participants will need instruction on how hovering + arrow keys work
			if ($('.hover-row:first-child:hover').length > 0) {
				linkList.left();
			} else if ($('.hover-row:not(:first-child):hover').length > 0 && isTable) { // table
				table.left();
			}
		} else if (kc === 39) { // right arrow
			if ($('.hover-row:first-child:hover').length > 0) {
				linkList.right();
			} else if ($('.hover-row:not(:first-child):hover').length > 0 && isTable) {
				table.right();
			}
		}
		// cancel speech because cell won't contain same content
		speechSynthesis.cancel();
	});

	function activateTableCell(kc, nthChild) {
		var ckc;
		if (nthChild === 2) {
			ckc = tableFirstColumnKeyCodes;
		} else if (nthChild === 3) {
			ckc = tableSecondColumnKeyCodes;
		} else if (nthChild === 4) {
			ckc = tableThirdColumnKeyCodes;
		}
		var cell = $('.hover-row:nth-child('+nthChild+') .cell:nth-child('+(1+ckc.indexOf(kc))+')');
		console.log(cell);
		etsy.getRequest('product', 'listings/'+cell.data('listing_id'), {});
	}

	/*
	 * Moving logic to external function to make keydown handler less awful
	 */
	function activateCategoryCell(kc) {
		var cell = $('.hover-row:first-child .cell:nth-child('+(1+linkListKeyCodes.indexOf(kc))+')');
		console.log(cell);
		if (cell.data('name') === '/') {
			// call the 'Popular Products' removal function in LinkedList
			linkList.removePopularProducts();
			etsy.getRequest('listings', 'listings/trending', {'limit': 30});
		} else {
			// check if popular products is already shown
			if ($('.hover-row').first().children(':first').data('name') !== '/') {
				linkList.addPopularProducts();
			}
			etsy.getRequest('listings', 'listings/active', {'limit': 30, 'category': $(this).data('name')});
		}
	}


/* 
To Do:

- Check whether pressing certain Fingers keys changes how the software operates while people interact with my application. If it does, read Fingers code and change those key bindings in a separate branch
- Add search capability + message about turning off Fingers
- Figure out how to allow people to go back. I believe that Table queues will save state since they only refresh when I instantiate a new Table object, which I only do at the beginning. I just don't provide an option to revert to the previous page. Should that be a special keyboard command as well? That tilda thing? <-- very possible
The tilda thing would require me setting a permanent cell on the UI and shifting over all hover rows by a cell + margin
This WILL NOT WORK for LinkList cells though

^ I like the tilda idea, but relying on current code isn't a good solution. Perhaps I'll include a global variable that keeps track of a stack of all etsy request URIs and data so I can just pop values off when going back.

Another option would be to just redo the whole shebang as a Node app again
*/



</script>
</body>
</html>